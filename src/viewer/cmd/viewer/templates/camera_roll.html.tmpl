<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Camera Roll</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <style media="screen">
      body {
        margin: 0;
        padding: 0;
        font-family: 'Open Sans', sans-serif;
      }
      .thumbnailBox {
        position: relative;
      }
      .thumbnailBox button {
        position: absolute;
        right: 0;
        top: 0;
        display: none;
      }
      .thumbnailBox:hover button {
        display: block;
      }
      #cameraroll-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Adjust as needed */
        gap: 10px; /* Adjust as needed */
        padding: 10px;
      }
      @media (min-width: 600px) {
        #cameraroll-grid {
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
      }

      @media (min-width: 900px) {
        #cameraroll-grid {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
      }
      h2.month-header {
        grid-column: 1 / -1; /* Span across all columns */
        text-align: left;
        margin: 20px 0 10px 0;
        padding: 0 10px;
        color: #333;
        font-size: 1.8em;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    {{ $origin := .OriginDomain }}
    {{ $viewer := .ViewerDomain }}
    {{ $lk := .LastKey }}
    {{ $isPrivate := .IsPrivate }}
    <div id="cameraroll-grid">
    </div>
    <p>
      {{ if ne .PrevLink "" }}
        <a href="{{ .PrevLink }}">Previous</a> &#124;
      {{ end }}
      <a href="/cameraroll/">Home</a>
      {{ if ne .NextLink "" }}
      &#124; <a href="{{ .NextLink }}">Next</a>
      {{ end }}
    </p>
    <p id="private_mode">
      <input type="checkbox" id="privateModeCheckbox"> Switch to private mode
    </p>
    <p id="copyinfo">
      Copy the HTML tag to clipboard by clicking the ðŸ“‹ button.
    </p>
    <script src="https://{{ $origin }}/assets/generate_access_token.js"></script>
    <script>
      const salt = "{{ .SaltForPrivateImage }}";

      // Check the checkbox if 'private=true' is already in the URL
      const urlParams = new URLSearchParams(window.location.search);
      const isPrivate = urlParams.has('private') && urlParams.get('private') === 'true';

      function copy(key, w, h) {
        const tag = '<img class="load-exif" src="https://{{ $origin }}/' + key + '" width="' + w + '" height="' + h + '" loading="lazy">';
        navigator.clipboard.writeText(tag);
        // Since buttons are dynamically generated, we can't rely on a fixed ID.
        // The checkmark will not be displayed on the button after copying.
        // This functionality will be removed in a later task.
      }

      const privateModeCheckbox = document.getElementById('privateModeCheckbox');
      if (isPrivate) {
        privateModeCheckbox.checked = true;
      }
      privateModeCheckbox.addEventListener('change', function() {
        const currentUrl = new URL(window.location.href);
        // Remove all existing query parameters
        currentUrl.pathname = '/cameraroll/';
        currentUrl.search = '';
        if (this.checked) {
          currentUrl.searchParams.set('private', 'true');
        }
        window.location.href = currentUrl.toString();
      });

      const thumbnailsData = [
        {{ range $i, $thumb := .Thumbnails }}
          {{ if or (and $isPrivate $thumb.Private) (and (not $isPrivate) (not $thumb.Private)) }}
            {
              id: "{{ $thumb.Id }}",
              timestamp: {{ $thumb.Timestamp }},
              private: {{ $thumb.Private }},
              width: {{ $thumb.Width }},
              height: {{ $thumb.Height }}
            },
          {{ end }}
        {{ end }}
      ];
      // Remove the trailing comma if any
      if (thumbnailsData.length > 0 && thumbnailsData[thumbnailsData.length - 1].id === "") {
        thumbnailsData.pop();
      }

      function groupThumbnailsByMonth(thumbnails) {
        return thumbnails.reduce((groups, thumb) => {
          const timestamp = thumb.timestamp;
          let key;
          if (timestamp) {
            const date = new Date(timestamp * 1000);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            key = `${year}-${month}`;
          } else {
            key = "Undefined";
          }

          if (!groups[key]) {
            groups[key] = [];
          }
          groups[key].push(thumb);
          return groups;
        }, {});
      }

      function sortGroupedThumbnails(groupedThumbnails) {
        const sortedKeys = Object.keys(groupedThumbnails).sort((a, b) => {
          if (a === "Undefined") return 1;
          if (b === "Undefined") return -1;
          return b.localeCompare(a); // Sort months in descending order (newest first)
        });

        const sortedGroups = {};
        sortedKeys.forEach(key => {
          sortedGroups[key] = groupedThumbnails[key];
        });
        return sortedGroups;
      }

      document.addEventListener('DOMContentLoaded', async function() {
        const camerarollGrid = document.getElementById('cameraroll-grid');
        if (!camerarollGrid) return;

        const grouped = groupThumbnailsByMonth(thumbnailsData);
        const sorted = sortGroupedThumbnails(grouped);

        for (const month in sorted) {
          const header = document.createElement('h2');
          header.classList.add('month-header');
          header.textContent = month;
          camerarollGrid.appendChild(header);

          for (const thumb of sorted[month]) {
            const thumbnailBox = document.createElement('div');
            thumbnailBox.classList.add('thumbnailBox');
            thumbnailBox.id = thumb.timestamp;
            thumbnailBox.dataset.timestamp = thumb.timestamp;

            const link = document.createElement('a');
            link.href = `https://{{ $viewer }}/image/${thumb.id}`;

            const img = document.createElement('img');
            img.dataset.src = `https://{{ $origin }}/thumbnail/${thumb.id}`;
            img.width = 133;
            img.height = 133;
            img.classList.add('thumbnailImage');
            img.dataset.private = thumb.private;

            link.appendChild(img);
            thumbnailBox.appendChild(link);

            if (!thumb.private) {
              const copyButton = document.createElement('button');
              copyButton.textContent = 'ðŸ“‹';
              copyButton.onclick = () => copy(thumb.id, thumb.width, thumb.height);
              thumbnailBox.appendChild(copyButton);
            }
            camerarollGrid.appendChild(thumbnailBox);
          }
        }

        // Load images after they are added to the DOM
        const images = document.querySelectorAll('img.thumbnailImage');
        if (!isPrivate) {
          images.forEach(img => {
            img.src = img.dataset.src;
          });
        } else {
          for (const img of images) {
            const url = new URL(img.dataset.src);
            const key = url.pathname; // Keep leading slash
            const token = await generateToken(key, salt);
            const imageUrl = new URL(img.dataset.src);
            imageUrl.searchParams.set('token', token);
            img.src = imageUrl.toString();
          }
        }
      });
    </script>

  </body>
</html>
