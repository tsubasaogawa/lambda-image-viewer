# Research: カメラロールのページネーション修正

## 1. 課題: ページネーションの順序が安定しない問題

**背景**:
現在のカメラロールのページネーションでは、次のページに進むと、本来表示されるべき過去の写真だけでなく、新しい写真が混ざって表示されることがある。これはユーザー体験を著しく損なう。

**原因分析**:
この問題は、単純なオフセットベースのページネーション（例: `LIMIT 50 OFFSET 50`）を、データの追加や削除が頻繁に発生する可能性のあるデータセットに対して使用している場合に典型的に発生する。また、DynamoDBのようなNoSQLデータベースでは、オフセットベースのページネーションは非効率であり、推奨されていない。

## 2. 解決策の調査

### 検討したアプローチ

1.  **オフセットベースのページネーションの維持**:
    - **メリット**: 実装が直感的に見える。
    - **デメリット**: パフォーマンスが低く、データの一貫性が保証されない。データの追加/削除でページがずれる。大規模データセットには不向き。

2.  **カーソルベース（キーセット）のページネーション**:
    - **メリット**: 高速で効率的。データの一貫性が保証される。状態を持たないため、実装がシンプルになる。DynamoDBの標準的なベストプラクティス。
    - **デメリット**: 「特定のページ番号へ直接ジャンプする」機能の実装が難しい（ただし、今回の要件は「次へ」のみなので問題ない）。

### 採用する技術

- **DynamoDB の `Query` オペレーションと `LastEvaluatedKey`**:
  - DynamoDBの `Query` オペレーションは、結果セットの最後に処理されたアイテムのキーを `LastEvaluatedKey` として返す。
  - 次のページを取得するリクエストでは、この `LastEvaluatedKey` を `ExclusiveStartKey` パラメータとして渡すことで、前回の続きから効率的にデータを取得できる。
  - これにより、データの追加や削除があっても、ページネーションの順序が一貫して保たれる。

## 3. 結論

**決定**:
- DynamoDBの `LastEvaluatedKey` を利用したカーソルベースのページネーションを実装する。

**理由**:
- **一貫性**: データの時系列順を正確に保証できるため。
- **パフォーマンス**: 大量の写真データに対してもスケール可能で、高速なレスポンスを維持できるため。
- **ベストプラクティス**: AWSが推奨する標準的な実装方法であるため。

**実装への影響**:
- Goのハンドラは、`LastEvaluatedKey` を受け取り、`ExclusiveStartKey` としてDynamoDBのクエリに渡し、結果として得られた新しい `LastEvaluatedKey` をテンプレートに渡す必要がある。
- HTMLテンプレートは、次ページへのリンクのクエリパラメータとして、受け取った `LastEvaluatedKey` （Base64エンコード推奨）を含める必要がある。